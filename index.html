<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- GENERAL --- */
        body { 
            background-color: white; 
            color: black; 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }

        /* --- HEADER --- */
        header { 
            background-color: black; 
            color: white; 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 20px; 
            box-sizing: border-box; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
        }
        h1 { 
            font-size: 1.5rem; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            margin: 0; 
        }

        /* --- CLOCK --- */
        .clock-container { 
            background-color: black; 
            border: 3px double #555; 
            border-radius: 8px; 
            padding: 5px; 
            width: 180px; /* Smaller default width */
            color: red; 
            font-family: 'Orbitron', sans-serif; 
            text-align: center; 
        }
        .clock-labels { color: #999; font-size: 0.4rem; display: flex; justify-content: space-around; margin-bottom: 2px; font-weight: bold; font-family: Arial, sans-serif; }
        .digital-row { border: 1px solid #333; border-radius: 5px; padding: 2px; margin-bottom: 2px; background: #0a0a0a; display: flex; justify-content: space-around; align-items: center; }
        .digit-group { font-size: 0.8rem; letter-spacing: 1px; }
        .digit-large { font-size: 1.2rem; font-weight: bold; letter-spacing: 2px; }

        .main-content { 
            width: 95%; 
            max-width: 1000px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding-bottom: 50px;
        }

        /* --- CONTROLS --- */
        .sales-controls { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
            justify-content: center; 
            background: #f4f4f4; 
            padding: 15px; 
            border-radius: 10px; 
            border: 1px solid #ccc; 
            width: 100%;
            box-sizing: border-box;
        }
        input { 
            padding: 10px; 
            border: 2px solid black; 
            border-radius: 5px; 
            font-size: 1rem; 
            flex: 1; /* Grow to fill space */
            min-width: 150px;
        }
        
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; border: none; border-radius: 5px; transition: 0.3s; white-space: nowrap; }
        .btn-add { background-color: black; color: white; width: 100%; } /* Full width button on mobile default */
        .btn-add:hover { background-color: #333; }

        /* --- DASHBOARD --- */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* 2 Columns on mobile */
            gap: 10px; 
            width: 100%; 
            margin-bottom: 20px; 
        }
        .stat-box { background-color: #f8f8f8; border: 2px solid black; padding: 10px; text-align: center; border-radius: 8px; box-shadow: 2px 2px 0px rgba(0,0,0,0.2); }
        .stat-title { font-size: 0.7rem; font-weight: bold; color: #555; text-transform: uppercase; }
        .stat-value { font-size: 1.2rem; font-weight: bold; color: black; margin-top: 5px; }
        .profit-pos { color: green; }

        /* --- TABLE (SCROLLABLE) --- */
        .table-container {
            width: 100%;
            overflow-x: auto; /* Adds scroll bar if table is too wide */
            margin-bottom: 30px;
            border: 1px solid #ddd;
        }

        table { width: 100%; border-collapse: collapse; min-width: 600px; /* Force minimum width so it doesn't squash */ }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 0.9rem; }
        th { background-color: black; color: white; }
        .btn-delete { background-color: #cc0000; color: white; padding: 5px 8px; font-size: 0.7rem; border-radius: 4px; cursor: pointer;}

        /* --- AI SECTION --- */
        .ai-section { background: linear-gradient(135deg, #000, #222); color: white; padding: 20px; border-radius: 15px; text-align: center; width: 100%; margin-bottom: 50px; box-sizing: border-box;}
        .ai-btn { background-color: white; color: black; margin-top: 10px; width: 100%; padding: 15px;}
        .prediction-result { color: #0f0; margin-top: 10px; font-size: 1.1rem; display: none; }

        /* --- MOBILE SPECIFIC RULES --- */
        @media (max-width: 600px) {
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            .sales-controls {
                flex-direction: column;
            }

            input {
                width: 100%; /* Full width inputs */
                box-sizing: border-box;
            }

            .dashboard-grid {
                grid-template-columns: 1fr 1fr; /* Keep 2 columns even on phone */
            }
            
            h1 { font-size: 1.2rem; }
        }

        @media (min-width: 601px) {
            .btn-add { width: auto; } /* Normal button on PC */
            .dashboard-grid { grid-template-columns: repeat(4, 1fr); } /* 4 Columns on PC */
        }

    </style>
</head>
<body>

    <header>
        <h1>Sales Manager</h1>
        <div class="clock-container">
            <div class="clock-labels"><span>DATE</span><span>MTH</span><span>YR</span></div>
            <div class="digital-row">
                <div class="digit-group" id="date">00</div>
                <div class="digit-group" id="month">00</div>
                <div class="digit-group" id="year">00</div>
            </div>
            <div class="digital-row" style="margin-bottom:0;">
                <div class="digit-large" id="full-time">00:00:00</div>
            </div>
            <div style="font-size:0.6rem; margin-top:2px; color:#fff;">TEMP: 29Â°C</div>
        </div>
    </header>

    <div class="main-content">
        
        <div class="sales-controls">
            <input type="email" id="customerEmail" placeholder="Customer Email (@)">
            <input type="number" id="costPrice" placeholder="Cost Price (â‚¹)">
            <input type="number" id="sellPrice" placeholder="Sell Price (â‚¹)">
            <button class="btn-add" onclick="addItem()">ADD SALE</button>
        </div>

        <div class="dashboard-grid">
            <div class="stat-box">
                <div class="stat-title">Total Sales</div>
                <div class="stat-value" id="totalSales">â‚¹0</div>
            </div>
            <div class="stat-box">
                <div class="stat-title">Total Profit</div>
                <div class="stat-value profit-pos" id="totalProfit">â‚¹0</div>
            </div>
            <div class="stat-box" style="background-color: #e6f7ff;">
                <div class="stat-title">Customers</div>
                <div class="stat-value" id="customerCount">0</div>
            </div>
            <div class="stat-box" style="background-color: #fffbe6;">
                <div class="stat-title">Status</div>
                <div class="stat-value" style="color:green; font-size:1rem; margin-top:8px;">Active</div>
            </div>
        </div>

        <h3 style="align-self: flex-start;">Transaction Database</h3>
        <div class="table-container">
            <table id="salesTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Email</th>
                        <th>Cost</th>
                        <th>Sold</th>
                        <th>Profit</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>

        <div class="ai-section">
            <h2>AI ANALYTICS ðŸ¤–</h2>
            <p>Predict future sales based on stored data.</p>
            <button class="ai-btn" onclick="predictTomorrow()">PREDICT PERFORMANCE</button>
            <div class="prediction-result" id="aiResult"></div>
        </div>

    </div>

    <script>
        // --- 1. CLOCK ---
        function updateClock() {
            const now = new Date();
            document.getElementById('date').innerText = String(now.getDate()).padStart(2, '0');
            document.getElementById('month').innerText = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('year').innerText = String(now.getFullYear()).slice(-2);
            document.getElementById('full-time').innerText = now.toLocaleTimeString('en-GB', { hour12: false });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- 2. DATABASE MANAGEMENT ---
        window.onload = fetchSalesData;

        async function fetchSalesData() {
            try {
                const response = await fetch('/api/sales');
                const data = await response.json();
                renderTable(data);
                updateDashboard(data);
            } catch (error) {
                console.error("Error loading data", error);
            }
        }

        async function addItem() {
            const email = document.getElementById('customerEmail').value;
            const cost = document.getElementById('costPrice').value;
            const sell = document.getElementById('sellPrice').value;

            if (!email || !email.includes('@')) { alert("Please enter a valid Customer Email"); return; }
            if (!cost || !sell) { alert("Please enter Cost and Sell prices"); return; }

            const profit = parseFloat(sell) - parseFloat(cost);

            const response = await fetch('/api/add-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, cost, sell, profit })
            });

            if (response.ok) {
                document.getElementById('customerEmail').value = '';
                document.getElementById('costPrice').value = '';
                document.getElementById('sellPrice').value = '';
                fetchSalesData();
            }
        }

        async function deleteItem(id) {
            if(confirm("Delete this record?")) {
                await fetch(`/api/delete-item/${id}`, { method: 'DELETE' });
                fetchSalesData();
            }
        }

        function renderTable(items) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if(items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="color:#999;">No data found.</td></tr>';
                return;
            }

            items.slice().reverse().forEach(item => {
                const row = `
                    <tr>
                        <td style="font-size:0.8rem">${item.date}</td>
                        <td style="color:#007bff; font-weight:bold; font-size:0.8rem">${item.email.split('@')[0]}...</td> 
                        <td>â‚¹${item.cost}</td>
                        <td>â‚¹${item.sell}</td>
                        <td style="color:${item.profit >= 0 ? 'green' : 'red'}">â‚¹${item.profit}</td>
                        <td><button class="btn-delete" onclick="deleteItem(${item.id})">Del</button></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateDashboard(items) {
            const totalSales = items.reduce((sum, item) => sum + item.sell, 0);
            const totalProfit = items.reduce((sum, item) => sum + item.profit, 0);
            document.getElementById('totalSales').innerText = "â‚¹" + Math.floor(totalSales);
            document.getElementById('totalProfit').innerText = "â‚¹" + Math.floor(totalProfit);
            document.getElementById('customerCount').innerText = items.length;
        }

        // --- 3. AI PREDICTION ---
        async function predictTomorrow() {
            const resultBox = document.getElementById('aiResult');
            resultBox.style.display = 'block';
            resultBox.innerText = "Analyzing...";

            try {
                const response = await fetch('/api/predict', { method: 'POST' });
                const data = await response.json();
                
                if(data.message) {
                    resultBox.innerText = data.message;
                    resultBox.style.color = "orange";
                } else {
                    resultBox.style.color = "#0f0";
                    resultBox.innerHTML = `Sales: â‚¹${data.tomorrowSales} <br> Profit: â‚¹${data.tomorrowProfit}`;
                }
            } catch (error) {
                resultBox.innerText = "Error in AI.";
            }
        }
    </script>
</body>
</html>
